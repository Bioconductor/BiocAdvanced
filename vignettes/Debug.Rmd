---
title: "Debugging R"
author: "Martin Morgan"
date: "July 31 - August 1, 2018"
vignette: >
  %\VignetteIndexEntry{Debugging}
  %\VignetteEngine{knitr::rmarkdown}
output: 
  BiocStyle::html_document
---

```{r style, echo = FALSE, results = 'asis'}
knitr::opts_chunk$set(
    eval=as.logical(Sys.getenv("KNITR_EVAL", "TRUE")),
    cache=as.logical(Sys.getenv("KNITR_CACHE", "TRUE")))
```

Setup

```{r}
f <- function(i) {
    i <- -i
    if (i == -3)
        stop("oops")
    i
}

g <- function(i) {
    f(i)
}

h <- function(i) {
    g(i)
}
```

```{r, eval = FALSE}
h(2)  # ok
h(3)  # error
```

## `browser()`

Useful for debugging code you are writing

```{r}
f1 <- f
f <- function(i) {
    browser()          # add this line to troubled function
    i <- -i
    if (i == -3)
        stop("oops")
    i
}
```

reset `f`

```{r}
f <- f1
```

## `traceback()`

Find where the problem is.

```{r, eval = FALSE}
h(3)
traceback()
```

## `debug()` / `debugonce()`

Useful for debugging other code

```{r, eval = FALSE}
debugonce(f)
h(3)
```

## `trace()`

`debug()` on steroids

```{r, eval = FALSE}
trace(f, quote(print(i)))
vapply(seq_len(5), h, numeric(1))
```

## `recover()`

`options(error=recover)` / `options(error = NULL)`

When it is not obvious where the error is occuring.

```{r, eval = FALSE}
vapply(seq_len(5), h, numeric(1))
```

## What about warnings?

```{r}
f1 <- f
f <- function(i) {
    i <- -i
    if (i == -3)
        warning("i is bad")
    i
}
```

```{r, eval = FALSE}
options(warn = 2)
h(2)
h(3)
```

```{r}
options(warn = 0)
f <- f1
```

# Handling unavoidable errors and warnings

## `tryCatch()`

```{r}
h <- function(i) {
    tryCatch({
        g(i)
    }, error = function(e) {
        warning(
            "C'est la vie!\n",
            "    error: ", conditionMessage(e)
        )
        NA
    })
}
```

## `withCallingHandlers()`
